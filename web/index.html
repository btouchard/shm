<!-- SPDX-License-Identifier: AGPL-3.0-or-later -->
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHM Hub</title>
    <link rel="icon" type="image/x-icon" href="/assets/shm-logo.ico">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: { 750: '#2d3748', 850: '#1a202c', 900: '#171923', 950: '#0d1117' },
                        primary: { 500: '#6366f1', 600: '#4f46e5' }
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } } }
                }
            }
        }
    </script>

    <!-- External Dependencies (with SRI where possible) -->
    <!-- Phosphor Icons: SRI omitted due to dynamic resource loading -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" integrity="sha384-9nhczxUqK87bcKHh20fSQcTGD4qq5GhayNYSYWqwBkINBhOfQLg/P5HG5lF1urn4" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Alpine.js App (ES Module) -->
    <script type="module" src="/js/app.js"></script>

    <style>
        [x-cloak] { display: none !important; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
    </style>
</head>

<body class="bg-gray-950 text-gray-200 font-sans antialiased overflow-hidden">

<!-- ===== SIDEBAR ===== -->
<aside class="fixed left-0 top-0 h-full w-64 bg-gray-900 border-r border-gray-800 z-30 flex flex-col" x-data="sidebar">
    <!-- Header -->
    <div class="p-4 border-b border-gray-800">
        <div class="flex items-center gap-3 mb-4">
            <img src="/assets/shm-logo.svg" alt="SHM Logo" class="w-8 h-8">
            <span class="font-bold text-lg tracking-tight text-white">SHM <span class="text-gray-500 font-medium">Hub</span></span>
        </div>

        <!-- Search Bar -->
        <div class="relative">
            <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm"></i>
            <input
                type="text"
                @input="onSearch($event.target.value)"
                placeholder="Search apps..."
                class="w-full bg-gray-950 border border-gray-800 rounded-lg pl-9 pr-3 py-2 text-sm text-gray-300 placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500/50 focus:border-primary-500"
            >
        </div>
    </div>

    <!-- Apps List -->
    <div class="flex-1 overflow-y-auto p-4 space-y-1">
        <button
            @click="selectApp(null)"
            class="w-full text-left px-3 py-2 rounded-lg transition-colors flex items-center justify-between group"
            :class="isSelected(null) ? 'bg-primary-500/10 text-primary-400 border border-primary-500/20' : 'text-gray-400 hover:bg-gray-800 hover:text-gray-300'"
        >
            <div class="flex items-center gap-2">
                <i class="ph-bold ph-stack text-sm"></i>
                <span class="text-sm font-medium">All Applications</span>
            </div>
            <span class="text-xs font-mono px-2 py-0.5 rounded bg-gray-800 text-gray-500 group-hover:bg-gray-700" x-text="$store.dashboard.stats.total_instances"></span>
        </button>

        <div class="border-t border-gray-800 my-2"></div>

        <template x-for="app in filteredApps" :key="app.slug">
            <button
                @click="selectApp(app.name)"
                class="w-full text-left px-3 py-2 rounded-lg transition-colors flex items-center justify-between group"
                :class="isSelected(app.name) ? 'bg-primary-500/10 text-primary-400 border border-primary-500/20' : 'text-gray-400 hover:bg-gray-800 hover:text-gray-300'"
            >
                <div class="flex items-center gap-2 min-w-0 flex-1">
                    <div class="w-6 h-6 rounded bg-gray-800 border border-gray-700 flex items-center justify-center flex-shrink-0 overflow-hidden">
                        <img
                            x-show="app.logo_url"
                            :src="app.logo_url ? app.logo_url + '?_r=' + $store.dashboard.refreshKey : ''"
                            :alt="app.name"
                            class="w-full h-full object-contain p-0.5"
                            @error="$el.style.display='none'; $el.nextElementSibling.style.display='block'"
                            @load="$el.style.display='block'; $el.nextElementSibling.style.display='none'"
                        >
                        <span
                            class="text-xs font-bold text-indigo-400"
                            :style="app.logo_url ? 'display:none' : ''"
                            x-text="app.name.charAt(0).toUpperCase()"
                        ></span>
                    </div>
                    <span class="text-sm font-medium truncate" x-text="app.name"></span>
                </div>
                <span class="text-xs font-mono px-2 py-0.5 rounded bg-gray-800 text-gray-500 group-hover:bg-gray-700 flex-shrink-0" x-text="getCount(app.name)"></span>
            </button>
        </template>

        <template x-if="$store.dashboard.applications.length === 0 && !$store.dashboard.loading">
            <div class="text-center py-8 text-gray-600">
                <i class="ph-duotone ph-ghost text-2xl mb-2"></i>
                <p class="text-xs">No applications yet</p>
            </div>
        </template>
    </div>

    <!-- Footer -->
    <div class="p-4 border-t border-gray-800">
        <div class="flex items-center justify-between text-xs text-gray-500">
            <div class="flex items-center gap-2">
                <span class="relative flex h-2 w-2">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                </span>
                <span x-text="$store.dashboard.stats.active_instances + ' active'"></span>
            </div>
            <button @click="refresh()" class="p-1 text-gray-500 hover:text-white hover:bg-gray-800 rounded transition-colors" :disabled="$store.dashboard.loading" aria-label="Refresh data">
                <i class="ph-bold ph-arrows-clockwise text-sm" :class="{ 'animate-spin': $store.dashboard.loading }" aria-hidden="true"></i>
            </button>
        </div>
    </div>
</aside>

<!-- ===== TOP NAVBAR ===== -->
<nav class="fixed top-0 left-64 right-0 z-40 bg-gray-950/80 backdrop-blur-md border-b border-gray-800" x-data="navbar">
    <div class="px-6">
        <div class="flex h-16 items-center justify-between">
            <div class="flex items-center gap-3">
                <h1 class="text-xl font-bold text-white" x-text="title"></h1>
                <span class="text-sm text-gray-500" x-text="countText"></span>
            </div>
            <div class="flex items-center gap-2">
                <div class="relative flex items-center">
                    <div class="absolute left-3 w-4 h-4 flex items-center justify-center text-gray-500">
                        <i x-show="!isSearching" class="ph-bold ph-magnifying-glass text-sm"></i>
                        <i x-show="isSearching" class="ph-bold ph-spinner animate-spin text-sm"></i>
                    </div>
                    <input
                        type="text"
                        x-model="searchQuery"
                        placeholder="Search instances..."
                        class="bg-gray-900 border border-gray-800 rounded-lg pl-9 pr-3 py-2 text-sm text-gray-300 placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500/50 focus:border-primary-500 w-64"
                    >
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- ===== MAIN CONTENT ===== -->
<main class="fixed top-16 left-64 right-0 bottom-0 overflow-y-auto" x-data="mainContent" @scroll.passive="handleScroll">
    <div class="p-6">
        <template x-for="(group, appName) in displayedGroups" :key="appName">
            <section class="mb-12 animate-fade-in" x-data="appSection">
                <!-- App Header -->
                <div class="flex items-center justify-between mb-6 border-b border-gray-800 pb-4">
                    <div class="flex items-center gap-4">
                        <!-- Logo or Initial (with fallback) -->
                        <div class="w-10 h-10 rounded-lg bg-gray-800 border border-gray-700 flex items-center justify-center shadow-inner overflow-hidden"
                             x-data="{ get logoUrl() { return $store.dashboard.applications.find(a => a.slug === group.appSlug)?.logo_url } }">
                            <img
                                x-show="logoUrl"
                                :src="logoUrl ? logoUrl + '?_r=' + $store.dashboard.refreshKey : ''"
                                :alt="appName"
                                class="w-full h-full object-contain p-1"
                                @error="$el.style.display='none'; $el.nextElementSibling.style.display='block'"
                                @load="$el.style.display='block'; $el.nextElementSibling.style.display='none'"
                            >
                            <span
                                class="text-lg font-bold text-indigo-400"
                                x-show="!logoUrl"
                                x-text="appName.charAt(0).toUpperCase()"
                            ></span>
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <h2 class="text-xl font-bold text-white" x-text="appName"></h2>
                                <template x-if="group.githubUrl && group.githubStars > 0">
                                    <a :href="group.githubUrl" target="_blank" class="flex items-center gap-1 px-2 py-0.5 rounded bg-gray-800 border border-gray-700 hover:border-gray-600 transition-colors text-xs text-gray-400 hover:text-gray-300">
                                        <i class="ph-fill ph-star text-yellow-500"></i>
                                        <span class="font-mono" x-text="formatNumber(group.githubStars || 0)"></span>
                                    </a>
                                </template>
                            </div>
                            <div class="text-xs text-gray-500 flex gap-2">
                                <span x-text="`${getAppTotalCount(appName)} instances`"></span>
                                <span>&bull;</span>
                                <span x-text="`Updated ${timeAgo(group.lastSeenGlobal)}`"></span>
                            </div>
                        </div>
                    </div>
                    <!-- Edit Button -->
                    <button
                        @click.stop="openEditModal(group.appSlug)"
                        class="p-2 text-gray-400 hover:text-white bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors border border-gray-700"
                        title="Edit application settings"
                        aria-label="Edit application settings"
                    >
                        <i class="ph-bold ph-gear text-lg" aria-hidden="true"></i>
                    </button>
                </div>

                <!-- Metrics Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-6">
                    <!-- OS Distribution Card -->
                    <div class="bg-gradient-to-br from-gray-900 to-gray-900/50 hover:from-gray-800 hover:to-gray-800/50 transition-colors rounded-lg p-3 border border-gray-800">
                        <p class="text-[9px] font-bold text-gray-500 uppercase tracking-widest truncate mb-2">OS Distribution</p>
                        <div class="space-y-1">
                            <template x-for="(count, os) in group.osCounts" :key="os">
                                <div class="flex items-center justify-between text-xs">
                                    <div class="flex items-center gap-1.5">
                                        <i class="ph-fill text-gray-600" :class="getOSIcon(os)"></i>
                                        <span class="text-gray-400 capitalize" x-text="os"></span>
                                    </div>
                                    <span class="text-white font-mono font-bold" x-text="count"></span>
                                </div>
                            </template>
                            <template x-if="!group.osCounts || Object.keys(group.osCounts).length === 0">
                                <div class="text-xs text-gray-600 italic">No OS data</div>
                            </template>
                        </div>
                    </div>

                    <!-- Business Metrics Cards -->
                    <template x-for="key in group.businessKeys" :key="key">
                        <button
                            @click="toggleMetricChart(appName, key)"
                            class="bg-gray-900/50 hover:bg-gray-800 transition-all rounded-lg p-3 border text-left"
                            :class="isMetricSelected(appName, key) ? 'border-primary-500 ring-2 ring-primary-500/20' : 'border-gray-800'"
                        >
                            <div class="flex items-start justify-between gap-2">
                                <div class="flex-1 min-w-0">
                                    <p class="text-[9px] font-bold text-gray-500 uppercase tracking-widest truncate mb-1" x-text="formatKey(key)"></p>
                                    <p class="text-xl font-bold text-white font-mono" x-text="formatNumber(group.sums[key])"></p>
                                </div>
                                <i class="ph-bold ph-chart-line text-sm flex-shrink-0" :class="isMetricSelected(appName, key) ? 'text-primary-500' : 'text-gray-600'"></i>
                            </div>
                        </button>
                    </template>
                </div>

                <!-- Chart Panel -->
                <div
                    x-show="getSelectedMetric(appName)"
                    x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0 -translate-y-2"
                    x-transition:enter-end="opacity-100 translate-y-0"
                    x-transition:leave="transition ease-in duration-150"
                    x-transition:leave-start="opacity-100 translate-y-0"
                    x-transition:leave-end="opacity-0 -translate-y-2"
                    class="mb-6 bg-gray-900 border border-gray-800 rounded-xl overflow-hidden"
                >
                    <!-- Chart Header -->
                    <div class="flex items-center justify-between border-b border-gray-800 px-6 py-4">
                        <div class="flex items-center gap-3">
                            <i class="ph-bold ph-chart-line text-primary-500 text-lg"></i>
                            <div>
                                <h3 class="text-sm font-bold text-white" x-text="formatKey(getSelectedMetric(appName))"></h3>
                                <p class="text-xs text-gray-500">Time series evolution</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <template x-for="period in periods" :key="period">
                                <button
                                    @click="selectPeriod(appName, period)"
                                    class="px-3 py-1 rounded text-xs font-medium transition-colors"
                                    :class="getPeriod(appName) === period ? 'bg-primary-500 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-gray-300'"
                                    x-text="period"
                                ></button>
                            </template>
                            <button @click="closeChart(appName)" class="ml-2 p-1.5 text-gray-500 hover:text-white hover:bg-gray-800 rounded transition-colors" aria-label="Close chart">
                                <i class="ph-bold ph-x text-sm" aria-hidden="true"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Chart Content -->
                    <div class="p-6 relative">
                        <div x-show="isChartLoading(appName)" class="absolute inset-0 flex items-center justify-center bg-gray-900/80 z-10">
                            <div class="text-center">
                                <i class="ph-bold ph-circle-notch animate-spin text-3xl text-gray-500"></i>
                                <p class="text-sm text-gray-500 mt-3">Loading chart data...</p>
                            </div>
                        </div>
                        <template x-if="hasNoData(appName) && !isChartLoading(appName)">
                            <div class="flex items-center justify-center py-12 text-gray-500">
                                <div class="text-center">
                                    <i class="ph-bold ph-info text-2xl mb-2"></i>
                                    <p class="text-sm">No data for this metric.</p>
                                </div>
                            </div>
                        </template>
                        <canvas
                            :id="canvasId(appName)"
                            x-show="!hasNoData(appName)"
                            class="w-full"
                            style="max-height: 300px;"
                        ></canvas>
                    </div>
                </div>

                <!-- Instances Table -->
                <div class="bg-gray-900 border border-gray-800 rounded-xl shadow-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm whitespace-nowrap">
                            <thead>
                                <tr class="bg-gray-850 border-b border-gray-800 text-[10px] text-gray-400 font-bold uppercase tracking-wider">
                                    <th class="px-5 py-3 w-48">Instance</th>
                                    <th class="px-5 py-3 w-32">Context</th>
                                    <template x-for="key in group.businessKeys" :key="key">
                                        <th class="px-5 py-3 text-right text-indigo-300" x-text="formatKey(key)"></th>
                                    </template>
                                    <th class="px-5 py-3 text-right w-24">Seen</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800/50">
                                <template x-for="inst in group.displayedInstances" :key="inst.instance_id">
                                    <tr class="hover:bg-gray-800/40 transition-colors cursor-pointer group" @click="openDrawer(inst, group.resourceKeys)">
                                        <td class="px-5 py-3">
                                            <div class="flex items-center gap-2">
                                                <div class="w-1.5 h-1.5 rounded-full" :class="inst.status === 'active' ? 'bg-emerald-500 shadow-[0_0_5px_rgba(16,185,129,0.5)]' : 'bg-red-500'"></div>
                                                <span class="font-mono text-gray-300 text-xs" x-text="inst.instance_id.substring(0, 8)"></span>
                                            </div>
                                            <div class="pl-3.5 mt-1 flex items-center gap-2">
                                                <span class="text-[9px] px-1.5 py-0.5 rounded bg-gray-800 border border-gray-700 text-gray-400" x-text="`v${inst.app_version}`"></span>
                                                <template x-for="tagKey in group.stringKeys" :key="tagKey">
                                                    <template x-if="inst.metrics?.[tagKey] && getIconForTag(inst.metrics[tagKey]) !== 'ph-tag'">
                                                        <i class="ph-fill text-xs text-gray-600" :class="getIconForTag(inst.metrics[tagKey])"></i>
                                                    </template>
                                                </template>
                                            </div>
                                        </td>
                                        <td class="px-5 py-3">
                                            <div class="text-gray-300 text-xs font-medium" x-text="inst.environment"></div>
                                            <div class="text-[9px] text-gray-500 uppercase" x-text="inst.deployment_mode"></div>
                                        </td>
                                        <template x-for="key in group.businessKeys" :key="key">
                                            <td class="px-5 py-3 text-right font-mono text-sm text-gray-200">
                                                <span
                                                    x-text="inst.metrics?.[key] !== undefined ? formatNumber(inst.metrics[key]) : '-'"
                                                    :class="{ 'text-gray-700': inst.metrics?.[key] === undefined }"
                                                ></span>
                                            </td>
                                        </template>
                                        <td class="px-5 py-3 text-right">
                                            <span class="text-xs text-gray-500" x-text="timeAgo(inst.last_seen_at)"></span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <template x-if="group.hasMore">
                        <div class="text-center py-4 text-gray-500 text-sm">
                            <i class="ph-bold ph-circle-notch animate-spin"></i>
                            <span class="ml-2">Loading more instances...</span>
                        </div>
                    </template>
                </div>
            </section>
        </template>

        <template x-if="isEmpty">
            <div class="flex flex-col items-center justify-center py-20 text-gray-600">
                <i class="ph-duotone ph-ghost text-4xl mb-4"></i>
                <p>No instances found</p>
            </div>
        </template>
    </div>
</main>

<!-- ===== INSTANCE DRAWER ===== -->
<div x-data="drawer" x-show="$store.dashboard.selectedInstance !== null" x-cloak class="fixed inset-0 z-50 flex justify-end" @keydown.escape.window="close()" role="dialog" aria-modal="true" aria-labelledby="drawer-title">
        <div @click="close()" class="absolute inset-0 bg-black/70 backdrop-blur-[2px] transition-opacity" x-show="$store.dashboard.selectedInstance !== null" x-transition.opacity aria-hidden="true"></div>

        <div
            class="relative w-full max-w-lg bg-gray-950 border-l border-gray-800 h-full shadow-2xl flex flex-col"
            x-show="$store.dashboard.selectedInstance !== null"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="translate-x-full"
            x-transition:enter-end="translate-x-0"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="translate-x-0"
            x-transition:leave-end="translate-x-full"
        >
            <template x-if="instance">
                <div class="flex flex-col h-full">
                    <!-- Drawer Header -->
                    <div class="px-6 py-5 border-b border-gray-800 bg-gray-900 flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <h3 id="drawer-title" class="text-xl font-bold text-white font-mono tracking-tight" x-text="instance.instance_id"></h3>
                                <span
                                    class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide border"
                                    :class="instance.status === 'active' ? 'bg-emerald-500/10 text-emerald-500 border-emerald-500/20' : 'bg-red-500/10 text-red-500 border-red-500/20'"
                                    x-text="instance.status"
                                ></span>
                            </div>
                            <p class="text-sm text-gray-400" x-text="`${instance.app_name} v${instance.app_version}`"></p>
                        </div>
                        <button @click="close()" class="text-gray-500 hover:text-white bg-gray-800 hover:bg-gray-700 p-2 rounded-lg transition" aria-label="Close drawer">
                            <i class="ph-bold ph-x text-lg" aria-hidden="true"></i>
                        </button>
                    </div>

                    <!-- Drawer Content -->
                    <div class="p-6 overflow-y-auto flex-1 space-y-8">
                        <!-- System Health -->
                        <div>
                            <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                                <i class="ph-bold ph-cpu"></i> System Health & Resources
                            </h4>
                            <div class="grid grid-cols-2 gap-3">
                                <template x-for="rKey in resourceKeys" :key="rKey">
                                    <template x-if="instance.metrics?.[rKey] !== undefined">
                                        <div class="bg-gray-900 border border-gray-800 p-3 rounded-lg flex flex-col">
                                            <span class="text-[10px] text-gray-500 font-bold uppercase mb-1" x-text="formatResourceKey(rKey)"></span>
                                            <div class="flex items-end justify-between">
                                                <span class="text-lg font-mono text-gray-200" x-text="formatNumber(instance.metrics[rKey])"></span>
                                                <i class="ph-fill text-gray-700 text-lg" :class="getResourceIcon(rKey)"></i>
                                            </div>
                                        </div>
                                    </template>
                                </template>
                                <template x-if="!resourceKeys?.length">
                                    <div class="col-span-2 text-xs text-gray-600 italic">No system metrics available.</div>
                                </template>
                            </div>
                        </div>

                        <!-- Environment Details -->
                        <div>
                            <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                                <i class="ph-bold ph-hard-drives"></i> Environment Details
                            </h4>
                            <div class="bg-gray-900 border border-gray-800 rounded-lg p-4 space-y-3 text-sm">
                                <div class="flex justify-between border-b border-gray-800 pb-2">
                                    <span class="text-gray-500">Mode</span>
                                    <span class="text-gray-300" x-text="instance.deployment_mode"></span>
                                </div>
                                <div class="flex justify-between border-b border-gray-800 pb-2">
                                    <span class="text-gray-500">Environment</span>
                                    <span class="text-gray-300" x-text="instance.environment"></span>
                                </div>
                                <template x-for="(val, key) in instance.metrics" :key="key">
                                    <template x-if="typeof val === 'string'">
                                        <div class="flex justify-between border-b border-gray-800 last:border-0 pb-2 last:pb-0">
                                            <span class="text-gray-500" x-text="formatKey(key)"></span>
                                            <span class="text-indigo-300 font-mono text-xs" x-text="val"></span>
                                        </div>
                                    </template>
                                </template>
                            </div>
                        </div>

                        <!-- JSON Payload -->
                        <div>
                            <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                                <i class="ph-bold ph-code"></i> JSON Payload
                            </h4>
                            <div class="bg-gray-950 rounded border border-gray-800 font-mono text-[10px] text-gray-400 overflow-hidden">
                                <table class="w-full">
                                    <tbody class="divide-y divide-gray-800">
                                        <template x-for="(val, key) in instance.metrics" :key="key">
                                            <tr class="hover:bg-gray-900/50">
                                                <td class="py-2 px-3 text-gray-500 border-r border-gray-800 w-1/3" x-text="key"></td>
                                                <td class="py-2 px-3 break-all text-gray-300" x-text="val"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>

<!-- ===== APPLICATION EDIT MODAL ===== -->
<div x-data="appEditModal" x-show="$store.dashboard.editingApp !== null" x-cloak class="fixed inset-0 z-50 flex items-center justify-center" @keydown.escape.window="close()" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <!-- Backdrop -->
        <div @click="close()" class="absolute inset-0 bg-black/70 backdrop-blur-[2px]" x-show="$store.dashboard.editingApp !== null" x-transition.opacity aria-hidden="true"></div>

        <!-- Modal -->
        <div
            class="relative w-full max-w-md bg-gray-900 border border-gray-800 rounded-xl shadow-2xl"
            x-show="$store.dashboard.editingApp !== null"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100 scale-100"
            x-transition:leave-end="opacity-0 scale-95"
        >
            <template x-if="$store.dashboard.editingApp">
                <div>
                    <!-- Header -->
                    <div class="px-6 py-4 border-b border-gray-800 flex items-center justify-between">
                        <div>
                            <h3 id="modal-title" class="text-lg font-bold text-white">Edit Application</h3>
                            <p class="text-sm text-gray-500" x-text="$store.dashboard.editingApp.name"></p>
                        </div>
                        <button @click="close()" class="p-2 text-gray-500 hover:text-white hover:bg-gray-800 rounded-lg transition-colors" aria-label="Close modal">
                            <i class="ph-bold ph-x text-lg" aria-hidden="true"></i>
                        </button>
                    </div>

                    <!-- Body -->
                    <div class="p-6 space-y-5">
                        <!-- Error Message -->
                        <template x-if="error">
                            <div class="p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-sm text-red-400 flex items-center gap-2">
                                <i class="ph-bold ph-warning-circle"></i>
                                <span x-text="error"></span>
                            </div>
                        </template>

                        <!-- Success Message -->
                        <template x-if="success">
                            <div class="p-3 bg-emerald-500/10 border border-emerald-500/20 rounded-lg text-sm text-emerald-400 flex items-center gap-2">
                                <i class="ph-bold ph-check-circle"></i>
                                <span x-text="success"></span>
                            </div>
                        </template>

                        <!-- GitHub URL Field -->
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">
                                <i class="ph-bold ph-github-logo mr-1"></i> GitHub Repository
                            </label>
                            <div class="flex gap-2">
                                <input
                                    type="url"
                                    x-model="form.github_url"
                                    placeholder="https://github.com/owner/repo"
                                    class="flex-1 bg-gray-950 border rounded-lg px-4 py-2.5 text-sm text-gray-300 placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500/50"
                                    :class="isValidGitHubUrl ? 'border-gray-800 focus:border-primary-500' : 'border-red-500/50'"
                                >
                                <button
                                    @click="refreshStars()"
                                    :disabled="refreshingStars || !form.github_url || !isValidGitHubUrl"
                                    class="px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-400 hover:text-white hover:bg-gray-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    title="Refresh GitHub stars"
                                    aria-label="Refresh GitHub stars"
                                >
                                    <i class="ph-bold ph-arrows-clockwise" :class="{ 'animate-spin': refreshingStars }" aria-hidden="true"></i>
                                </button>
                            </div>
                            <p class="mt-1.5 text-xs text-gray-600">Used to display GitHub stars badge</p>
                            <template x-if="!isValidGitHubUrl">
                                <p class="mt-1 text-xs text-red-400">Invalid GitHub URL format</p>
                            </template>
                        </div>

                        <!-- Logo URL Field -->
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">
                                <i class="ph-bold ph-image mr-1" aria-hidden="true"></i> Logo URL
                            </label>
                            <input
                                type="url"
                                x-model="form.logo_url"
                                placeholder="https://example.com/logo.png"
                                class="w-full bg-gray-950 border rounded-lg px-4 py-2.5 text-sm text-gray-300 placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500/50"
                                :class="isValidLogoUrl ? 'border-gray-800 focus:border-primary-500' : 'border-red-500/50'"
                            >
                            <p class="mt-1.5 text-xs text-gray-600">Custom logo image (SVG, PNG, or JPG) - HTTPS only</p>
                            <template x-if="!isValidLogoUrl">
                                <p class="mt-1 text-xs text-red-400">Invalid URL. Must be HTTPS with valid image extension or from allowed domain.</p>
                            </template>
                        </div>

                        <!-- Logo Preview -->
                        <template x-if="form.logo_url">
                            <div class="flex items-center gap-3 p-3 bg-gray-950 border border-gray-800 rounded-lg">
                                <img :src="form.logo_url" alt="Logo preview" class="w-10 h-10 object-contain rounded" @error="$el.style.display='none'">
                                <span class="text-xs text-gray-500">Logo preview</span>
                            </div>
                        </template>

                        <!-- Current Stats -->
                        <div class="pt-3 border-t border-gray-800">
                            <p class="text-xs text-gray-500 mb-2">Current Stats</p>
                            <div class="flex items-center gap-4 text-sm">
                                <div class="flex items-center gap-1.5 text-gray-400">
                                    <i class="ph-fill ph-star text-yellow-500"></i>
                                    <span x-text="$store.dashboard.editingApp.stars || 0"></span>
                                    <span class="text-gray-600">stars</span>
                                </div>
                                <template x-if="$store.dashboard.editingApp.stars_updated_at">
                                    <span class="text-xs text-gray-600" x-text="'Updated ' + new Date($store.dashboard.editingApp.stars_updated_at).toLocaleDateString()"></span>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="px-6 py-4 border-t border-gray-800 flex items-center justify-end gap-3">
                        <button
                            @click="close()"
                            class="px-4 py-2 text-sm font-medium text-gray-400 hover:text-white transition-colors"
                        >
                            Cancel
                        </button>
                        <button
                            @click="save()"
                            :disabled="saving || !hasChanges || !isFormValid"
                            class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                        >
                            <i x-show="saving" class="ph-bold ph-spinner animate-spin"></i>
                            <span x-text="saving ? 'Saving...' : 'Save Changes'"></span>
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>

</body>
</html>
